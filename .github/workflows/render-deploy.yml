name: Render Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RENDER_SERVICE_URL: https://astu-smart-complaints-backend.onrender.com

    steps:
      - name: Create GitHub deployment record
        id: create_deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              auto_merge: false,
              required_contexts: [],
              environment: 'production',
              description: 'Deploying to Render (production)'
            });

            core.setOutput('deployment_id', deployment.data.id.toString());

      - name: Mark deployment as in progress
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ steps.create_deployment.outputs.deployment_id }}'),
              state: 'in_progress',
              environment: 'production',
              environment_url: process.env.RENDER_SERVICE_URL,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'Render deployment triggered'
            });

      - name: Trigger Render deploy hook
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "RENDER_DEPLOY_HOOK_URL secret is missing"
            exit 1
          fi

          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

      - name: Mark deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ steps.create_deployment.outputs.deployment_id }}'),
              state: 'success',
              environment: 'production',
              environment_url: process.env.RENDER_SERVICE_URL,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'Render deployment hook accepted'
            });

      - name: Mark deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ steps.create_deployment.outputs.deployment_id }}'),
              state: 'failure',
              environment: 'production',
              environment_url: process.env.RENDER_SERVICE_URL,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'Render deployment trigger failed'
            });
